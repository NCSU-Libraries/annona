<!DOCTYPE html>
<html>

<head>
  <title>My first Vue app</title>
  <script src="https://unpkg.com/vue"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/url-parse/dist/url-parse.js"></script>
  <link rel="stylesheet" href="iiif_annotation.css">

</head>

<body>
  <div id="components-demo">
    <iiif-annotation annotationurl="https://raw.githubusercontent.com/tomcrane/iiif-collector/master/objects/paragraph.json"></iiif-annotation>
    <iiif-annotation annotationurl="annotation1.json"></iiif-annotation>
  <iiif-annotation annotationurl="annotation2.json"></iiif-annotation>
  <iiif-annotation annotationurl="annotation3.json"></iiif-annotation>
  <iiif-annotation annotationurl="https://raw.githubusercontent.com/tomcrane/iiif-collector/master/objects/paragraph.json"></iiif-annotation>
<iiif-annotation annotationurl="https://raw.githubusercontent.com/tomcrane/iiif-collector/master/objects/word.json"></iiif-annotation>
<iiif-annotation annotationurl="https://raw.githubusercontent.com/tomcrane/iiif-collector/master/objects/table.json"></iiif-annotation>

<iiif-annotation annotationurl="https://raw.githubusercontent.com/tomcrane/iiif-collector/master/objects/plate.json"></iiif-annotation>
</div>

  <script>

Vue.component('iiif-annotation', {
  props: ['annotationurl'],
  data: function () {
    return {
       anno: '',
        manifest: '',
        showImage: false,
        image: '',
        canvas: '',
        manifestUrl: ''
    }
  },
created() {
axios.get(this.annotationurl).then(response => {
            this.anno = response.data
            var refCanvas = this.anno['target'] ? this.anno['target'] : this.anno['on']
            var manifest = refCanvas['dcterms:isPartOf'] ? refCanvas['dcterms:isPartOf'] : refCanvas['within']
            this.manifestlink = manifest['id'] ? manifest['id'] : manifest['@id']
          }).then(response => {
axios.get(this.manifestlink).then(response => {
            this.manifest = response.data
            for(var idx = 0; idx < this.manifest.sequences[0].canvases.length; idx++){
            var existing = this.manifest.sequences[0].canvases[idx];
            if(existing['@id'] == this.canvasRegion['canvasId']){
                this.canvas = existing;
                }
              } 
                var baseImageUrl = this.canvas.images[0].resource.service['@id']  ? this.canvas.images[0].resource.service['@id'] : this.canvas.images[0].resource['@id'];
                this.image = baseImageUrl + '/' +  this.canvasRegion['canvasRegion'] + "/full/0/default.jpg"
              })
})
},
  methods: {
    toggle: function(image_uri, event){
      console.log(image_uri)

  var fullImage = document.querySelector("img[data-assoc-canvas='"+ image_uri+"']");
  console.log(fullImage)
  var change_html = event.srcElement != undefined ?  event.srcElement : event.target;
  if (fullImage.style.display == 'none'){
    fullImage.style.display='inline-block';
    change_html.innerHTML = "Hide Full Image"
  } else {
    fullImage.style.display= 'none';
    change_html.innerHTML = "View Full Image"
  }
  
  
}
  },
  computed: {
        label: function() {
          var label = this.anno.label ? this.anno.label : this.anno.resource.label
          return label
        },
        chars: function() {
          var res = this.anno.body ? this.anno.body : this.anno.resource
          var textual_body = ''
          if (Array.isArray(res) == false){
          res = [res]
           }
           for (var i=0; i < res.length; i++){
            var res_data = res[i]
            if (res_data['type'] == 'TextualBody'){
            var purpose = res_data['purpose'] ? res_data['purpose'] : 'text';
            textual_body += `<div class="${res_data['purpose']}">${res_data['value']}</div></div>`;
            } 

           }
           return textual_body
        },
        ocr: function(){
          var res = this.anno.body ? this.anno.body : this.anno.resource
          var chars = res['chars'] && res['@type'] == 'cnt:ContentAsText' ? res['chars'] : '';
          return chars

        },
        fullImage: function(){
          var src_link = this.canvas.images[0].resource.service['@id']  ? this.canvas.images[0].resource.service['@id'] : this.canvas.images[0].resource['@id'];
          var fullImage =  this.canvasRegion['canvasRegion'] != "full" ? src_link + '/full/full/0/default.jpg' : '';
          return fullImage

        },
        canvasRegion: function(){
          var canvasId = this.anno.target != undefined ? this.anno.target : this.anno.on;
            canvasId = canvasId['id'] ? canvasId['id'] : canvasId['@id']
            var canvasRegion = canvasId.split("#")[1].split("=")[1]
            canvasId = canvasId.split("#")[0]
            return {'canvasId':canvasId, 'canvasRegion':canvasRegion}
        }, 
        dataset: function(){
           var res = this.anno.body ? this.anno.body : this.anno.resource
           var dataset_format = res['format'] && res['@type'] == 'dctypes:Dataset' ? res['format'] : '';
           var dataset_url = res['@id'] && res['@type'] == 'dctypes:Dataset' ? res['@id'] : '';
          return {'dataset_format':dataset_format, 'dataset_url':dataset_url}
        },
        canvasHash: function() {
          var id = this.anno.target.id
          var url = new URL(id)
          return url.hash
        }        
      },
       template: `<div class="iiifannotation">
       <img v-bind:src="image">
       <img v-bind:src="fullImage" style="display:none;" v-bind:data-assoc-canvas="image">
       
       <figcaption v-show="label != undefined" v-html="label"></figcaption>
       <div v-bind:id="ocr" class="text" v-show="ocr != ''">{{ocr}}</div>
       <p v-show="dataset['dataset_format'] != ''"><b><a href={{dataset.dataset_url}}>Download dataset ({{dataset.dataset_format}})</a></b></p>
       <div v-html="chars"></div>
       <button v-on:click="toggle(image, $event)" class="togglebutton" v-show="fullImage != ''">View Full Image</button>
       <div id="link_to_object">
          Full object: <a v-bind:href="manifest.related['@id']" target="_blank">{{manifest["label"]}}</a>

       </div>
       </div>`
 
})
    

new Vue({ el: '#components-demo' });
   
  </script>
</body>

</html>
